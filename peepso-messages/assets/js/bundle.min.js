!function i(a,o,n){function d(t,e){if(!o[t]){if(!a[t]){var s="function"==typeof require&&require;if(!e&&s)return s(t,!0);if(l)return l(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}s=o[t]={exports:{}},a[t][0].call(s.exports,function(e){return d(a[t][1][e]||e)},s,s.exports,i,a,o,n)}return o[t].exports}for(var l="function"==typeof require&&require,e=0;e<n.length;e++)d(n[e]);return d}({1:[function(e,t,s){e("./messages")},{"./messages":4}],2:[function(p,e,c){!function(h){!function(){Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;var e,d=(e="undefined"!=typeof window?window.jQuery:void 0!==h?h.jQuery:null)&&e.__esModule?e:{default:e},s="undefined"!=typeof window?window._:void 0!==h?h._:null,a="undefined"!=typeof window?window.peepso:void 0!==h?h.peepso:null,i="undefined"!=typeof window?window.peepsodata:void 0!==h?h.peepsodata:null,l=p("./util");let o=window.peepsomessagesdata&&peepsomessagesdata.character_limit,n=window.peepsomessagesdata&&peepsomessagesdata.send_button_text,r=window.peepsomessagesdata&&peepsomessagesdata.mute_confirm;class t{constructor(e={}){this.$container=(0,d.default)(e.el),this.$wrapper=this.$container.closest(".ps-js-conversation-wrapper"),this.$back=this.$container.find(".ps-js-conversation-back"),this.$recipients=this.$container.find(".ps-js-recipients"),this.$addRecipients=this.$container.find(".ps-js-add-recipients"),this.$participants=this.$container.find(".ps-js-conversation-participant-summary"),this.$scrollable=this.$container.find(".ps-js-conversation-scrollable"),this.$messages=this.$container.find(".ps-js-conversation-messages"),this.$messagesLoading=this.$container.find(".ps-js-conversation-messages-loading"),this.$messagesList=this.$container.find(".ps-js-conversation-messages-list"),this.$messagesTemporary=this.$container.find(".ps-js-conversation-messages-temporary"),this.$messagesTyping=this.$container.find(".ps-js-conversation-messages-typing"),this.$messageTemplate=this.$container.find("[data-template=message-item]"),this.$loading=this.$container.siblings(".ps-js-conversation-loading"),this.$options=this.$container.find(".ps-js-conversation-options"),this.$optionsDropdown=this.$container.find(".ps-js-conversation-dropdown"),this.$postboxTemplate=this.$container.find("[data-template=postbox]"),this.$postbox=null,this.$enterToSend=null,this.opts=d.default.extend({},e),this.params={msg_id:this.opts.id},this.enterToSend=!1,this.$back.off("click").on("click",e=>{e.preventDefault(),this.hide()}),a.hooks.addAction("messages_conversation_before_send",e=>this.actionBeforeSend(e)),a.hooks.addAction("messages_conversation_sent",e=>this.actionSent(e))}show(){this.$wrapper.addClass("ps-messages__view--open")}hide(){this.$wrapper.removeClass("ps-messages__view--open")}fetch(t={}){var e=d.default.ajax({url:i.ajaxurl_legacy+"messagesajax.get_messages_in_conversation",type:"POST",dataType:"json",data:t,beforeSend:function(e){e.setRequestHeader("X-PeepSo-Nonce",i.peepso_nonce)}});let s=d.default.Deferred();return s.abort=e.abort,e.done(e=>{e.success?s.resolve(e.data):e.errors&&1===t.page?s.reject(e.errors):s.resolve({})}),e.fail(()=>s.reject()),s}load(){var e=d.default.extend(this.params,{get_participants:1,get_options:1,get_unread:1});this.$container.hide(),this.$loading.show(),this.fetch(e).done(e=>{this.render(e),void 0!==e.enter_to_send&&(this.enterToSend=+e.enter_to_send),this.initPostbox(),this.initOptions(),this.initRecipientsForm(),this.startLongPolling(),setTimeout(()=>this.maybeLoadPrevious(),2e3)}).always(()=>{this.$loading.hide(),this.$container.show()})}maybeLoadPrevious(){let e="scroll.ps-page-messages";this.$scrollable.off(e),this.$scrollable.on(e,()=>{this.$scrollable[0].scrollTop<30&&(this.$scrollable.off(e),this.loadPrevious().then(e=>{e.html&&this.maybeLoadPrevious()}))})}loadPrevious(){return new Promise((t,e)=>{this.$messagesLoading.css("visibility","");var s=this.$messagesList.children(".ps-js-message").first(),s={msg_id:this.params.msg_id,from_id:s.data("id"),direction:"old",get_unread:1};this.fetch(s).done(e=>{this.render(e,"prepend"),setTimeout(()=>t(e),1e3)}).fail(e).always(()=>{this.$messagesLoading.css("visibility","hidden")})})}loadNext(){var e=this.$messagesList.children(".ps-js-message").last(),e={msg_id:this.params.msg_id,from_id:e.data("id"),direction:"new",get_unread:1};return this.loadNextPromise&&this.loadNextPromise.abort(),this.loadNextPromise=this.fetch(e),this.loadNextPromise.done(e=>{let t=this.$messagesTemporary.children(".ps-js-temporary-message");(t=e.ids&&e.ids.length?t.slice(0,e.ids.length):t).remove(),this.render(e),(e.currently_typing||e.ids&&e.ids.length)&&this.restartLongPolling()}),this.loadNextPromise}render(e,t="append"){let s=this.$scrollable[0],i,a,o;var n;this.destroyed||((e.ids&&e.ids.length||e.currently_typing)&&("append"===t?i=Math.abs(s.scrollHeight-s.clientHeight-s.scrollTop):"prepend"===t&&(n=getComputedStyle(s.firstElementChild).paddingTop,n=parseInt(n)||0,a=this.$messagesLoading.outerHeight()+n-s.scrollTop,o=this.$messagesList[0].firstElementChild)),e.html&&(n=(0,l.filterMessages)((0,d.default)(e.html)),"append"===t?this.$messagesList.append(n):"prepend"===t&&this.$messagesList.prepend(n)),e.html_participants&&this.$participants.html(e.html_participants),e.html_options&&this.$optionsDropdown.html(e.html_options),void 0!==e.receipt&&+e.receipt&&(n=+e.unread||0,this.showUnreadCheckmark(n)),!e.currently_typing||e.ids&&e.ids.length?this.$messagesTyping.empty():this.$messagesTyping.html(e.currently_typing),"append"===t&&i<30?(e.ids&&e.ids.length||e.currently_typing)&&requestAnimationFrame(()=>{s.scrollTop=s.scrollHeight,(0,l.loadAsyncContents)(e.html).then(()=>{s.scrollTop=s.scrollHeight})}):"prepend"===t&&(n=o?(0,d.default)(o).position().top:0,s.scrollTop=Math.max(0,n-a)))}initPostbox(){var e=this.$container.find("div#postbox-message").html(this.$postboxTemplate.html());let t=null;this.$postbox=e.pspostbox({autosize:!window.ReactNativeWebView,text_length:o,send_button_text:n,save_url:"messagesajax.add_message",postbox_req:e=>(this.isSaving=!0,e.parent_id=this.params.msg_id,t=e),on_before_save:()=>{this.actionBeforeSend(t),this.$postbox.find(".ps-postbox-input:visible textarea").val("")},on_save:()=>this.actionSent(t),on_queue_clear:()=>{this.isSaving=!1,this.$postbox.$posttabs.on_cancel()}}),this.$postbox.$posttabs.off("peepso_posttabs_submit"),this.$enterToSend=this.$postbox.find("#enter-to-send"),this.$enterToSend[0].checked=this.enterToSend,this.$enterToSend.on("click",()=>{this.$postbox.on_change(),a.ajax.post("messagesajax.enter_to_send",{enter_to_send:this.$enterToSend.is(":checked")?1:0})}),this.$postbox.$textarea.on("focus click",(0,s.throttle)(function(){a.ajax.post("messagesajax.mark_read_messages_in_conversation",{msg_id:this.params.msg_id})},2e3).bind(this)),this.$postbox.on("postbox.post_cancel postbox.post_saved",e=>{this.$postbox&&this.$postbox.$textarea.trigger("keyup").trigger("input")}),a.observer.addFilter("peepso_postbox_enter_to_send",()=>this.$enterToSend.is(":checked")),a.observer.addFilter("peepso_postbox_input_changed",(e,t)=>{t===this.$postbox&&(0,l.currentlyTyping)(this.params.msg_id)},10,2)}initOptions(){let t=(0,d.default)(document),s="click.conversation-options";this.$options.off(s).on(s,e=>{e.stopPropagation(),this.$optionsDropdown.is(":visible")?(this.$optionsDropdown.hide(),t.off(s)):(this.$optionsDropdown.show(),t.one(s,()=>this.$optionsDropdown.hide()))}),this.$optionsDropdown.off("click").on("click","[data-menu]",e=>{e.preventDefault();var t=(0,d.default)(e.currentTarget);switch(t.data("menu")){case"block-user":this.blockUser(t.data("warningText"),t.data("userId"));break;case"add-recipients":this.addRecipients();break;case"toggle-read-receipt":this.toggleReadReceipt(!+t.data("send"),t[0]);break;case"toggle-mute":this.toggleMute(!+t.data("muted"),t[0]);break;case"leave-conversation":this.leaveConversation(t.data("warningText"),t.attr("href"))}})}initRecipientsForm(){let i={};this.$recipients.find("select[name=recipients]").selectize({valueField:"id",labelField:"display_name",searchField:"display_name",plugins:["remove_button"],closeAfterSelect:!0,render:{option:function(e,t){var s=t(e.display_name);return`<div><img src="${t(e.avatar||i[e.id]||"")}" /><span>${s}</span></div>`},item:function(e,t){var s=t(e.display_name);return`<div><img src="${t(e.avatar||i[e.id]||"")}" /><span>${s}</span></div>`}},load:(e,s)=>{a.ajax.post("messagesajax.get_available_recipients",{parent_id:this.params.msg_id,keyword:e}).done(e=>{let t;e.success&&(t=e.data.available_participants||[],d.default.each(t,function(e,t){i[t.id]=t.avatar})),s(t)})},onInitialize:function(){var e=`<img src="${this.$input.data("loading")}" />`;this.$wrapper.append(e),this.$control_input.on("input",function(e){let t=(0,d.default)(this);setTimeout(function(){t.trigger("keyup")},0)})}}),this.$addRecipients.off("click").on("click",()=>{let s=this.$recipients.find("select[name=recipients]");var e=this.$recipients.find("select[name=add-participant-nonce]"),e={parent_id:this.params.msg_id,participants:s.val(),add_participant_nonce:e.val()};a.ajax.post("messagesajax.add_participants",e).done(e=>{var t;e.success&&((t=e.data.new_conversation_redirect)?(window.location=t,window.location.reload()):(this.$participants.html(e.data.summary),(0,a.dialog)(e.notices[0]).show().autohide(),s.find("option").remove(),d.default.each(e.data.available_participants,function(e,t){t=(0,d.default)("<option/>").val(t.id).text(t.display_name);s.append(t)}),s[0].selectize.clearOptions(!0),this.$recipients.slideUp()))})})}showUnreadCheckmark(e){let t=this.$messagesList.find(".gci-check-circle"),s=(0,d.default)();0<e&&(s=t.slice(0-e),t=t.not(s)),t.addClass("read"),s.removeClass("read")}blockUser(e,t){(0,a.dialog)(e).confirm(e=>{e&&window.ps_member.block_user(t)})}addRecipients(){this.$recipients.slideDown()}addTemporaryContent(e,t){e=(0,a.template)(this.$messageTemplate.text())({content:e,attachment:t});this.$messagesTemporary.append(e)}toggleReadReceipt(t,s){var e={msg_id:this.params.msg_id,read_notif:t?1:0};a.ajax.post("messagesajax.set_message_read_notification",e).done(e=>{e.success&&(s instanceof Element&&((e=(0,d.default)(s)).data("send",t?1:0),e.removeClass("disabled").addClass(t?"":"disabled"),e.find("span").text(e.data(`${t?"dontSend":"send"}Text`))),t)&&a.ajax.post("messagesajax.mark_read_messages_in_conversation",{msg_id:this.params.msg_id})})}toggleMute(e,i){if(e){let t=(0,a.dialog)(r.replace("{msg_id}",this.params.msg_id)).show(),s=t.$el.find("input[type=radio]");e=t.$el.find("input[type=button]");e.removeAttr("onclick"),e.on("click",e=>{e.preventDefault(),this.toggleMuteConfirm(s.filter(":checked").val(),i),t.hide()})}else this.toggleMuteConfirm(0,i)}toggleMuteConfirm(e,t){let s={parent_id:this.params.msg_id,mute:e},i=!!+e;a.ajax.post("messagesajax.set_mute",s).done(e=>{e.success&&(t instanceof Element&&((e=(0,d.default)(t)).data("muted",i?1:0),e.find("span").text(e.data(`${i?"muted":"unmuted"}Text`)),e.find("i").attr("class",i?"gcis gci-bell-slash":"gcir gci-bell")),a.observer.doAction(`psmessages_conversation_${i?"":"un"}mute`,s.parent_id))})}leaveConversation(e,t){(0,a.dialog)(e).confirm(e=>{e&&(window.location=t)})}destroy(){var e;this.stopLongPolling(),this.$container.hide(),this.$addRecipients.off("click"),this.$recipients.hide(),(e=this.$recipients.find("select[name=recipients]")[0].selectize)&&e.destroy(),this.hide(),this.$messagesList.children().remove(),this.$container.find("div#postbox-message").empty(),this.$postbox=null,this.destroyed=!0}startLongPolling(){}stopLongPolling(){}restartLongPolling(){}actionBeforeSend(e){let t;"photo"===e.type?t={type:"photo",count:e.files.length}:"giphy"===e.type&&(t={type:"giphy",count:1}),this.addTemporaryContent(e.content,t),this.$scrollable[0].scrollTop=this.$scrollable[0].scrollHeight}actionSent(){this.loadNext()}}c.default=t}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./util":14}],3:[function(e,t,s){!function(t){!function(){Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;var a=e("undefined"!=typeof window?window.jQuery:void 0!==t?t.jQuery:null),o="undefined"!=typeof window?window.peepso:void 0!==t?t.peepso:null;e("undefined"!=typeof window?window.peepsodata:void 0!==t?t.peepsodata:null);function e(e){return e&&e.__esModule?e:{default:e}}let n=window.peepsomessagesdata&&peepsomessagesdata.mute_confirm;s.default=class{constructor(e){this.id=null,this.$el=(0,a.default)(e),this.$avatars=this.$el.find("[data-ps=avatars]"),this.$users=this.$el.find("[data-ps=users]"),this.$btnOptions=this.$el.find("[data-ps=btn-options]"),this.$dropdown=this.$el.find("[data-ps=dropdown]"),this.$recipients=this.$el.siblings("[data-ps=recipients]"),this.$btnAddRecipients=this.$recipients.find("[data-ps=btn-add-recipients]"),this.$btnCancelRecipients=this.$recipients.find("[data-ps=btn-cancel-recipients]"),this.$participants=this.$el.find("[data-ps=participants]"),this.$btnOptions.on("click",()=>this.toggleDropdown()),this.$dropdown.on("click",()=>this.toggleDropdown(!1)),this.$dropdown.on("click","[data-menu]",e=>this.onDropdownClick(e)),o.hooks.addAction("messages_conversation_open",e=>this.reset(e)),o.hooks.addAction("messages_conversation_options",(...e)=>this.updateOptions(...e)),o.hooks.addAction("messages_conversation_participants",(...e)=>this.updateParticipants(...e))}reset(e){e!==this.id&&(this.id=e,this.$avatars.empty(),this.$users.empty(),this.recipientsReset())}updateOptions(e){this.$dropdown.html(e)}updateParticipants(e,t){var s;t instanceof Array&&(1===t.length?(s=`<div class="ps-avatar"><img src="${t[0].avatar}"></div>`,this.$avatars.html(s),this.$users.html(e)):1<t.length&&(s=t.map(e=>`<div class="ps-avatar"><img src="${e.avatar}"></div>`),this.$avatars.html(s.join("")),this.$users.html(e)))}toggleDropdown(e){(e=void 0!==e?!!e:this.$dropdown.is(":hidden"))?(this.$dropdown.show(),setTimeout(()=>{(0,a.default)(document).off("mouseup.ps-messages-header"),(0,a.default)(document).on("mouseup.ps-messages-header",e=>{var t=this.$btnOptions.add(this.$dropdown);t.filter(e.target).length||t.find(e.target).length||this.toggleDropdown(!1)})},1)):(this.$dropdown.hide(),(0,a.default)(document).off("mouseup.ps-messages-header"))}blockUser(e,t){(0,o.dialog)(e).confirm(e=>{e&&window.ps_member.block_user(t)})}toggleReadReceipt(t,s){var e={msg_id:this.id,read_notif:t?1:0};o.ajax.post("messagesajax.set_message_read_notification",e).done(e=>{e.success&&(s instanceof Element&&((e=(0,a.default)(s)).data("send",t?1:0),e.removeClass("disabled").addClass(t?"":"disabled"),e.find("span").text(e.data(`${t?"dontSend":"send"}Text`))),t)&&o.ajax.post("messagesajax.mark_read_messages_in_conversation",{msg_id:this.id})})}toggleMute(e,i){if(e){let t=(0,o.dialog)(n.replace("{msg_id}",this.id)).show(),s=t.$el.find("input[type=radio]");e=t.$el.find("input[type=button]");e.removeAttr("onclick"),e.on("click",e=>{e.preventDefault(),this.toggleMuteConfirm(s.filter(":checked").val(),i),t.hide()})}else this.toggleMuteConfirm(0,i)}toggleMuteConfirm(e,t){let s={parent_id:this.id,mute:e},i=!!+e;o.ajax.post("messagesajax.set_mute",s).done(e=>{e.success&&(t instanceof Element&&((e=(0,a.default)(t)).data("muted",i?1:0),e.find("span").text(e.data(`${i?"muted":"unmuted"}Text`)),e.find("i").attr("class",i?"gcis gci-bell-slash":"gcir gci-bell")),o.observer.doAction(`psmessages_conversation_${i?"":"un"}mute`,s.parent_id))})}leaveConversation(e,t){(0,o.dialog)(e).confirm(e=>{e&&(window.location=t)})}onDropdownClick(e){e.preventDefault();var t=(0,a.default)(e.currentTarget);switch(t.data("menu")){case"block-user":this.blockUser(t.data("warningText"),t.data("userId"));break;case"add-recipients":this.recipientsToggle();break;case"toggle-read-receipt":this.toggleReadReceipt(!+t.data("send"),t[0]);break;case"toggle-mute":this.toggleMute(!+t.data("muted"),t[0]);break;case"leave-conversation":this.leaveConversation(t.data("warningText"),t.attr("href"))}}recipientsToggle(){this.$recipients.slideDown(),this.recipientsInit()}recipientsInit(){var e=this.$recipients.find("select[name=recipients]");if(!e[0].selectize){let i={};e.selectize({valueField:"id",labelField:"display_name",searchField:"display_name",plugins:["remove_button"],closeAfterSelect:!0,render:{option(e,t){var s=t(e.display_name);return`<div><img src="${t(e.avatar||i[e.id]||"")}" /><span>${s}</span></div>`},item(e,t){var s=t(e.display_name);return`<div><img src="${t(e.avatar||i[e.id]||"")}" /><span>${s}</span></div>`}},load:(e,t)=>{e={parent_id:this.id,keyword:e};o.ajax.post("messagesajax.get_available_recipients",e).done(e=>e.success?(e=e.data.available_participants||[],a.default.each(e,(e,t)=>i[t.id]=t.avatar),t(e)):t())},onInitialize(){this.$wrapper.append(`<img src="${this.$input.data("loading")}" />`),this.$control_input.on("input",e=>setTimeout(()=>(0,a.default)(e.currentTarget).trigger("keyup"),0))}}),this.$btnAddRecipients.on("click",()=>this.recipientsAdd()),this.$btnCancelRecipients.on("click",()=>this.recipientsCancel())}}recipientsReset(){this.$recipients.hide(),this.$btnAddRecipients.off("click"),this.$btnCancelRecipients.off("click");var e=this.$recipients.find("select[name=recipients]");e[0].selectize&&(e[0].selectize.destroy(),delete e[0].selectize)}recipientsAdd(){let s=this.$recipients.find("select[name=recipients]");var e=this.$recipients.find("select[name=add-participant-nonce]"),e={parent_id:this.id,participants:s.val(),add_participant_nonce:e.val()};o.ajax.post("messagesajax.add_participants",e).done(e=>{var t;e.success&&((t=e.data.new_conversation_redirect)?(window.location=t,window.location.reload()):(o.hooks.doAction("messages_conversation_participants",e.data.summary,e.data.users),(0,o.dialog)(e.notices[0]).show().autohide(),s.find("option").remove(),a.default.each(e.data.available_participants,(e,t)=>{t=(0,a.default)("<option/>").val(t.id).text(t.display_name);s.append(t)}),s[0].selectize.clearOptions(!0),this.$recipients.slideUp()))})}recipientsCancel(){this.$recipients.hide()}}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],4:[function(i,e,t){!function(s){!function(){var o=t("undefined"!=typeof window?window.jQuery:void 0!==s?s.jQuery:null),n="undefined"!=typeof window?window._:void 0!==s?s._:null,e="undefined"!=typeof window?window.peepso:void 0!==s?s.peepso:null,d=t(i("./list")),l=t(i("./new")),r=t(i("./header")),h=t(i("./thread")),p=t(i("./messagebox"));function t(e){return e&&e.__esModule?e:{default:e}}e.observer.addFilter("chat_enabled",function(e){return e=document.querySelector(".ps-js-messages-list")?!1:e}),(0,o.default)(function(){let t=location.hash.replace(/^#/,"").split(",").reduce((e,t)=>{var[t,s]=t.split("=");return t&&(e[t]=s||""),e},{});var e=document.querySelectorAll(".ps-js-messages-list");e.forEach(e=>new d.default({el:e,args:Object.assign({},t)}));document.querySelectorAll("[data-id=ps-new-message-form]").forEach(e=>new l.default({el:e,args:Object.assign({},t)}));var s=document.querySelector("[data-ps=message-header]"),s=(s&&new r.default(s),document.querySelector("[data-ps=message-thread]")),s=(s&&new h.default(s),document.querySelector("[data-ps=messagebox]"));s&&new p.default(s);let i=(0,o.default)(".pso-messages"),a=i.children(".pso-messages__side");if(i.on("click","[data-ps=btn-toggle]",()=>{a.toggleClass("pso-messages__side--open")}),i.on("click","[data-ps=btn-focus]",()=>{i.toggleClass("pso-messages--focus")}),e.length){let e=(0,o.default)(".ps-js-messages"),t="ps-messages--narrow";s="resize.ps-message-conversation";(0,o.default)(window).off(s).on(s,(0,n.throttle)(function(){e.width()<800?e.addClass(t):e.removeClass(t)})).triggerHandler(s)}})}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./header":3,"./list":5,"./messagebox":11,"./new":12,"./thread":13}],5:[function(d,e,l){!function(n){!function(){Object.defineProperty(l,"__esModule",{value:!0}),l.default=void 0;var a=e("undefined"!=typeof window?window.jQuery:void 0!==n?n.jQuery:null),s="undefined"!=typeof window?window.peepso:void 0!==n?n.peepso:null,o="undefined"!=typeof window?window.peepsodata:void 0!==n?n.peepsodata:null,i=d("./util");e(d("./conversation"));function e(e){return e&&e.__esModule?e:{default:e}}let t=window.peepsomessagesdata&&peepsomessagesdata.per_page;l.default=class{constructor(e={}){this.$container=(0,a.default)(e.el),this.$form=this.$container.find(".ps-js-messages-search-form"),this.$query=this.$form.find("input[name=query]"),this.$btnClear=this.$form.find(".ps-js-btn-clear").hide(),this.$btnShowAll=(0,a.default)(".ps-js-messages-show-all"),this.$btnShowUnread=(0,a.default)(".ps-js-messages-show-unread"),this.$scrollable=this.$container.find(".ps-js-messages-list-scrollable"),this.$table=this.$container.find(".ps-js-messages-list-table"),this.$loading=this.$container.find(".ps-js-messages-list-loading"),this.opts=e,this.foundPages=0,this.currentConversationID=null,this.params={type:"inbox",unread_only:0,query:null,page:1,per_page:t},this.$query.on("input",()=>{var e=this.$query.val().trim();e.length?this.$btnClear.show():this.$btnClear.hide(),(!e||3<=e.length)&&e!==this.params.query&&(this.params.query=e,this.load())}),this.$query.trigger("input"),this.$query.on("keyup",e=>{"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),(e=this.$query.val().trim()).length?this.$btnClear.show():this.$btnClear.hide(),e!==this.params.query)&&(this.params.query=e,this.load())}),this.$btnClear.on("click",()=>{this.$btnClear.hide(),this.$query.removeAttr("value").val(""),this.params.query&&(this.params.query="",this.load())}),this.$btnShowAll.on("click",e=>{e.preventDefault(),this.params.unread_only=0,this.$btnShowAll.addClass("active"),this.$btnShowUnread.removeClass("active"),this.load()}),this.$btnShowUnread.on("click",e=>{e.preventDefault(),this.params.unread_only=1,this.$btnShowAll.removeClass("active"),this.$btnShowUnread.addClass("active"),this.load()}),this.$table.on("click",".ps-js-messages-list-item",e=>{e=+(0,a.default)(e.currentTarget).data("conversation-id");e&&(this.getIDFromURL()===e?this.select(e):this.updateURL(e))}),window.addEventListener("hashchange",e=>{var t=e.oldURL.match(/^([^#]+)(?:#(\d+))*/),e=e.newURL.match(/^([^#]+)#(\d+)/);t&&e&&t[1]===e[1]&&t[2]!==e[2]&&this.select(e[2])});e="peepso_messages_after_send.messages-list";(0,a.default)(window).off(e).on(e,()=>{setTimeout(()=>{this.currentConversationID=null,this.params.query=null,this.$query.trigger("input")},1e3)})}fetch(i={}){return new Promise((t,s)=>{var e={url:o.ajaxurl_legacy+"messagesajax.get_messages",type:"POST",data:i,dataType:"json",beforeSend:function(e){e.setRequestHeader("X-PeepSo-Nonce",o.peepso_nonce)}};this.fetchXhr&&this.fetchXhr.abort(),this.fetchXhr=a.default.ajax(e).done(e=>{e.success?t(e.data):e.errors&&1===i.page?s(e.errors):t([])}).fail(s).always(()=>{delete this.fetchXhr})})}load(){this.params.page=1,this.$table.empty(),this.$loading.show(),this.fetch(this.params).then(t=>{this.foundPages=t.total_pages,this.$loading.hide(),this.params.query?this.$btnClear.show():this.$btnClear.hide();var s=(0,a.default)(t.html),s=(0,i.filterMessages)(s);if(this.$table.empty().append(s),this.highlightItem(this.currentConversationID),0<t.total){let e=this.getIDFromURL();e||(t=(s=this.$container.closest(".pso-messages")).children(".pso-messages__side"),10<Math.abs(s.width()-t.width())&&(s=this.$table.find(".ps-js-messages-list-item").first(),e=s.data("conversation-id"))),e&&!this.pageLoaded&&(this.pageLoaded=!0,this.select(e))}1<this.foundPages&&this.maybeLoadNext()}).catch(()=>{}).then(()=>this.pageLoaded=!0)}loadNext(){this.params.page++,this.$loading.show(),this.fetch(this.params).then(e=>{this.$loading.hide(),this.$table.append((0,i.filterMessages)((0,a.default)(e.html))),this.highlightItem(this.currentConversationID),this.foundPages>this.params.page&&this.maybeLoadNext()}).catch(()=>{})}maybeLoadNext(){if(this.$table.off("scroll"),this.currentConversationID){var e=`[data-conversation-id="${this.currentConversationID}"]`;if(!this.$table.children(e).length)return void this.loadNext()}this.$table.on("scroll",()=>{var e=this.$table.innerHeight()+this.$table.scrollTop();this.$table[0].scrollHeight-e<30&&(this.$table.off("scroll"),this.loadNext())}),this.$table.trigger("scroll")}select(e){this.currentConversationID!==(e=+e)&&(this.currentConversationID=e,this.updateURL(e),this.highlightItem(e),this.markAsRead(e)),s.hooks.doAction("messages_conversation_open",e);var e=this.$container.closest(".pso-messages"),t=e.children(".pso-messages__side");Math.abs(e.width()-t.width())<=10&&t.removeClass("pso-messages__side--open")}getIDFromURL(){var e=window.location.hash;if(e){e=e.match(/^#(\d+)/);if(e)return+e[1]}return null}updateURL(e){e="#"+e;window.location.hash!==e&&(window.location.hash=e)}highlightItem(e){var t=this.$table.children();let s=t.filter(`[data-conversation-id="${e}"]`);e="pso-messages-list__item--selected";t.not(s).filter("."+e).removeClass(e),s.length&&!s.hasClass(e)&&(s.addClass(e),setTimeout(function(){s[0].scrollIntoView({block:"nearest",inline:"nearest"})},100))}markAsRead(e){s.ajax.post("messagesajax.mark_read_messages_in_conversation",{msg_id:e}),this.$table.children(`[data-conversation-id="${e}"]`).removeClass("pso-messages-list__item--unread")}}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./conversation":2,"./util":14}],6:[function(e,t,s){peepso.class("MessageboxOption",function(e,t,s){let i=0;return class{constructor(){this.eventId="messagebox-"+ ++i,this.$toggle=null,this.$dropdown=null}toggle(e){(e=void 0===e?this.$dropdown.is(":hidden"):e)?this.show():this.hide()}show(){this.$dropdown.show(),setTimeout(()=>{s(document).off("mouseup."+this.eventId).on("mouseup."+this.eventId,e=>{var t=this.$toggle.add(this.$dropdown);t.filter(e.target).length||t.find(e.target).length||this.hide()})},1)}hide(){this.$dropdown.hide(),s(document).off("mouseup."+this.eventId)}}})},{}],7:[function(e,t,s){!function(a){!function(){var e,n=(e="undefined"!=typeof window?window.jQuery:void 0!==a?a.jQuery:null)&&e.__esModule?e:{default:e},t="undefined"!=typeof window?window.peepso:void 0!==a?a.peepso:null;let s=("undefined"!=typeof window?window.peepsodata:void 0!==a?a.peepsodata:null).location.api_key;class i extends peepso.class("MessageboxOption"){constructor(e){super(e),this.location=null,this.messagebox=e,this.$el=e.$el,this.$toggle=this.$el.find("[data-ps=option][data-id=location]"),this.$dropdown=this.$el.find("[data-ps=dropdown][data-id=location]"),this.$input=this.$dropdown.find("input[type=text]"),this.$loading=this.$dropdown.find(".ps-js-location-loading"),this.$result=this.$dropdown.find(".ps-js-location-result"),this.$map=this.$dropdown.find(".ps-js-location-map"),this.$select=this.$dropdown.find(".ps-js-select"),this.$remove=this.$dropdown.find(".ps-js-remove"),this.listItemTemplate=(0,t.template)(this.$dropdown.find("[data-tmpl=item]").text()),this.titleTemplateSingle=(0,t.template)(this.$dropdown.find("[data-tmpl=title_single]").text()),this.titleTemplateMulti=(0,t.template)(this.$dropdown.find("[data-tmpl=title_multi]").text()),this.$toggle.on("click",()=>this.toggle()),this.$input.on("input",e=>this.onInputInput(e)),this.$result.on("click","[data-place-id]",e=>this.onItemClick(e)),this.$select.on("click",e=>this.onSelectClick(e)),this.$remove.on("click",e=>this.onRemoveClick(e)),t.hooks.addFilter("messagebox_data","loc",(...e)=>this.onMessageboxData(...e)),t.hooks.addFilter("messagebox_title_extra",(...e)=>this.onMessageboxTitle(...e)),t.hooks.addFilter("messagebox_is_empty",(...e)=>this.onFilterIsEmpty(...e)),t.hooks.addAction("messagebox_reset","loc",(...e)=>this.onMessageboxReset(...e))}show(){super.show(),this.$input.focus(),this.initialize||(this.initialize=!0,this.$result.empty().append(this.$loading.clone()),this.search("").done(e=>{this.updateList(e),this.detectLocation().done((e,t)=>{this.updateMarker(null),this.updateMap(e,t),this.$select.hide(),this.$remove.hide()})}))}set(e){e?(this.location=e,this.$toggle.addClass("pso-messages-post__addon--active"),this.$remove.show()):(this.location=null,this.updateMarker(null),this.$toggle.removeClass("pso-messages-post__addon--active"),this.$remove.hide()),this.messagebox.render(),this.messagebox.$textarea.trigger("input")}search(t=""){if(!t)return this.searchNearby();let i=this.searchToken=Date.now();return n.default.Deferred(s=>{t||i===this.searchToken&&s.reject(),this.loadService("autocomplete").done(e=>{e.getPlacePredictions({input:t},(e,t)=>{i===this.searchToken&&("OK"===t?s.resolve(e):s.reject())})})})}searchNearby(){let o=this.searchToken=Date.now();return n.default.Deferred(a=>{this.detectLocation().done((s,i)=>{this.loadService("places").done(e=>{var t={location:new google.maps.LatLng(s,i),types:["establishment"],rankBy:google.maps.places.RankBy.DISTANCE};e.nearbySearch(t,(e,t)=>{o===this.searchToken&&("OK"===t?a.resolve(e):a.reject())})})}).fail(()=>o===this.searchToken&&a.reject())})}placeDetail(i){return n.default.Deferred(s=>{if(this.placeDetailCache=this.placeDetailCache||{},this.placeDetailCache[i])return s.resolve(this.placeDetailCache[i]);this.loadService("places").done(e=>{e.getDetails({placeId:i},(e,t)=>{"OK"===t?(this.placeDetailCache[i]=e,s.resolve(e)):s.reject()})})})}onMessageboxData(e,t){var s,i;return t===this.messagebox&&this.location&&({name:t,latitude:s,longitude:i}=this.location,e.location={name:t,latitude:s,longitude:i}),e}onMessageboxTitle(e=[],t,s){return s===this.messagebox&&this.location&&(s=(t.mood?this.titleTemplateMulti:this.titleTemplateSingle)(this.location),e.push(s)),e}onFilterIsEmpty(e,t,s){return e=t===this.messagebox&&s.location?!1:e}onMessageboxReset(e){e===this.messagebox&&(this.set(null),this.$select.hide())}onInputInput(e){this.$result.empty().append(this.$loading.clone()),clearTimeout(this.searchTimer),this.searchTimer=setTimeout(()=>{this.search(this.$input.val().trim()).done(e=>{this.updateList(e),this.updateMarker(null),this.$select.hide(),this.$remove.hide()})},1e3)}onItemClick(e){e.preventDefault(),e.stopPropagation();let a=(0,n.default)(e.currentTarget).data();this.placeDetail(a.placeId).done(e=>{var t=a.name,s=e.geometry.location,e=e.geometry.viewport,i=s.lat(),s=s.lng();this.updateMap(i,s,e),this.updateMarker(i,s),this.$select.show(),this.$remove.hide(),this.$select.data({placeId:a.placeId,name:t,latitude:i,longitude:s})})}onSelectClick(e){e.preventDefault(),e.stopPropagation(),this.$select.hide(),this.set(this.$select.data()),this.toggle(!1)}onRemoveClick(e){e.preventDefault(),e.stopPropagation(),this.set(null),this.toggle(!1)}detectLocation(){return n.default.Deferred(t=>{let s=(...e)=>{this.detectLocationCache=e,t.resolve(...e)};if(this.detectLocationCache)return t.resolve(...this.detectLocationCache);this.detectLocationByDevice().done((e,t)=>s(e,t)).fail(()=>{this.detectLocationByAPI().done((e,t)=>s(e,t)).fail(()=>{this.detectLocationByIP().done((e,t)=>s(e,t)).fail(()=>t.reject())})})})}detectLocationByDevice(){return n.default.Deferred(t=>{if("https:"!==window.location.protocol)return t.reject();navigator.geolocation.getCurrentPosition(e=>t.resolve(e.coords.latitude,e.coords.longitude),()=>t.reject(),{timeout:1e4})})}detectLocationByAPI(){return n.default.Deferred(t=>{if(!s)return t.reject();n.default.post("https://www.googleapis.com/geolocation/v1/geolocate?key="+s,e=>{t.resolve(e.location.lat,e.location.lng)}).fail(e=>t.reject(e))})}detectLocationByIP(){return n.default.Deferred(s=>{let i;n.default.ajax({url:"https://ipapi.co/jsonp",dataType:"jsonp",success:e=>{var{latitude:e,longitude:t}=e||{};e&&t&&(i=!0,s.resolve(e,t))},complete:()=>i||s.reject()})})}loadLibrary(){return n.default.Deferred(t=>{if(this.loadLibraryLoaded)return t.resolve();if(this.loadLibraryCallbacks=this.loadLibraryCallbacks||[],this.loadLibraryCallbacks.push(t),!this.loadLibraryLoading){let e="fn_"+Date.now();window[e]=()=>{for(this.loadLibraryLoaded=!0,this.loadLibraryLoading=!1;this.loadLibraryCallbacks.length;)this.loadLibraryCallbacks.shift().resolve();delete window[e]};t=document.createElement("script");t.async=!0,t.type="text/javascript",t.src=`https://maps.googleapis.com/maps/api/js?libraries=places&key=${s}&loading=async&callback=`+e,document.body.appendChild(t)}})}loadService(s){return n.default.Deferred(t=>{this.loadServiceObjects=this.loadServiceObjects||{},this.loadServiceObjects[s]&&t.resolve(this.loadServiceObjects[s]),this.loadLibrary().done(()=>{var e;"autocomplete"===s?(this.loadServiceObjects[s]=new google.maps.places.AutocompleteService,t.resolve(this.loadServiceObjects[s])):"places"===s?(e=document.createElement("div"),document.body.appendChild(e),this.loadServiceObjects[s]=new google.maps.places.PlacesService(e),t.resolve(this.loadServiceObjects[s])):t.reject()})})}updateMap(t,s,i){this.loadLibrary().done(()=>{var e=new google.maps.LatLng(t,s);this.map?this.map.setCenter(e):this.map=new google.maps.Map(this.$map[0],{center:e,zoom:15,draggable:!1,scrollwheel:!1,disableDefaultUI:!0}),i?this.map.fitBounds(i):this.map.setZoom(15)})}updateMarker(e,t){if(!this.map)return n.default.Deferred(e=>e.resolve());this.loadLibrary().done(()=>{this.marker&&this.marker.setMap(null),this.map&&e&&t&&(this.marker=new google.maps.Marker({position:new google.maps.LatLng(e,t),map:this.map,title:"You are here (more or less)"}))})}updateList(e){e=e.map(e=>this.listItemTemplate(this.mapData(e))).join("");this.$result.html(e)}mapData(e){let t,s,i;return i=e.name?(t=e.place_id,s=e.name,e.vicinity):(t=e.place_id,i=e.description.split(", "),s=i.shift(),i.join(", ")),{place_id:t,name:s,description:i}}}t.hooks.addAction("messagebox_init","location",e=>new i(e))}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],8:[function(e,t,s){!function(a){!function(){var e,t=(e="undefined"!=typeof window?window.jQuery:void 0!==a?a.jQuery:null)&&e.__esModule?e:{default:e},s="undefined"!=typeof window?window.peepso:void 0!==a?a.peepso:null;class i extends peepso.class("MessageboxOption"){constructor(e){super(e),this.mood=null,this.messagebox=e,this.$el=e.$el,this.$toggle=this.$el.find("[data-ps=option][data-id=moods]"),this.$dropdown=this.$el.find("[data-ps=dropdown][data-id=moods]"),this.$cancel=this.$dropdown.find("[data-ps=btn-cancel]"),this.$remove=this.$dropdown.find("[data-ps=btn-remove]"),this.titleTemplate=this.$dropdown.find("script[data-tmpl=title]").text(),this.$toggle.on("click",()=>this.toggle()),this.$dropdown.on("click","[data-mood]",e=>this.onItemClick(e)),this.$cancel.on("click",e=>this.onCancelClick(e)),this.$remove.on("click",e=>this.onRemoveClick(e)),s.hooks.addFilter("messagebox_data","moods",(...e)=>this.onFilterData(...e)),s.hooks.addFilter("messagebox_validate",(...e)=>this.onFilterValidate(...e)),s.hooks.addFilter("messagebox_is_empty",(...e)=>this.onFilterIsEmpty(...e)),s.hooks.addFilter("messagebox_title_extra",(...e)=>this.onMessageboxTitle(...e)),s.hooks.addAction("messagebox_reset","moods",(...e)=>this.onMessageboxReset(...e))}set(e,t){var s;e?(s=this.$dropdown.find(`[data-id=${e}]`).addClass("active"),this.mood=[e,t],this.$toggle.addClass("pso-messages-post__addon--active"),this.$dropdown.find(".active").not(s).removeClass("active"),this.$remove.show()):(this.mood=null,this.$toggle.removeClass("pso-messages-post__addon--active"),this.$dropdown.find(".active").removeClass("active"),this.$remove.hide()),this.messagebox.render(),this.messagebox.$textarea.trigger("input")}onFilterData(e,t){return t===this.messagebox&&(e.mood=this.mood?this.mood[0]:void 0),e}onFilterValidate(e,t,s){return e=t===this.messagebox?!!s.mood||e:e}onFilterIsEmpty(e,t,s){return e=t===this.messagebox&&s.mood?!1:e}onMessageboxTitle(e=[],t,s){return s===this.messagebox&&this.mood&&(s=this.titleTemplate.replace("##icon##",this.mood[0]).replace("##mood##",this.mood[1]),e.push(s)),e}onMessageboxReset(e){e===this.messagebox&&this.set(null)}onItemClick(e){e.preventDefault(),e.stopPropagation();e=(0,t.default)(e.currentTarget).data();this.mood&&this.mood[0]===e.id?this.set(null):this.set(e.id,e.mood),this.toggle(!1)}onRemoveClick(e){e.preventDefault(),e.stopPropagation(),this.set(null),this.toggle(!1)}onCancelClick(e){e.preventDefault(),e.stopPropagation(),this.toggle(!1)}}s.hooks.addAction("messagebox_init","moods",e=>new i(e))}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],9:[function(e,t,s){peepso.class("MessageboxType",function(e,t,s){let i=t.hooks;return class{constructor(e,t){this.type=t,this.active=!1,this.messagebox=e,this.$el=e.$el,this.$types=this.$el.find("[data-ps=types]"),this.$typeInputs=this.$el.find("[data-ps=type_inputs]"),this.$typeInput=this.$typeInputs.children(`[data-id=${this.type}]`),this.attachEvents(),this.attachHooks()}attachEvents(){this.$types.on("click",`[data-id=${this.type}]`,e=>this.onTypeClick(e))}attachHooks(){i.addFilter("messagebox_data",(...e)=>this.onFilterData(...e)),i.addFilter("messagebox_validate",(...e)=>this.onFilterValidate(...e)),i.addFilter("messagebox_is_empty",(...e)=>this.onFilterIsEmpty(...e)),i.addAction("messagebox_saved",(...e)=>this.onActionSaved(...e)),i.addAction("messagebox_reset",(...e)=>this.onActionReset(...e)),i.addAction("messagebox_toggle_type",(...e)=>this.onActionToggleType(...e)),i.addAction("messagebox_toggle_type",(...e)=>this._triggerInput(...e),99)}show(){this.active=!0,this.$types.children(`[data-id=${this.type}]`).addClass("pso-active"),this.$typeInput.show(),this.$typeInput.length&&this.$typeInputs.show(),i.doAction("messagebox_toggle_type",this.type,this.messagebox)}hide(){this.active=!1,this.$types.children(`[data-id=${this.type}]`).removeClass("pso-active"),this.$typeInput.hide(),this.$typeInputs.children("[data-id]:visible").length||this.$typeInputs.hide()}onFilterData(e,t){return t===this.messagebox&&this.active,e}onFilterValidate(e,t,s){return t===this.messagebox&&this.active,e}onFilterIsEmpty(e,t,s){return t===this.messagebox&&this.active,e}onActionSaved(e){this.messagebox}onActionReset(e){e===this.messagebox&&this.hide()}onActionToggleType(e,t){t===this.messagebox&&e!==this.type&&this.hide()}onTypeClick(e){e.preventDefault(),e.stopPropagation(),this.show()}_triggerInput(e,t){t===this.messagebox&&e===this.type&&this.messagebox.$textarea.trigger("input")}}})},{}],10:[function(e,t,s){peepso.class("MessageboxTypeText",function(t,s,e){var i=s.hooks;return i.addAction("messagebox_init","text",e=>new(s.class(t))(e)),class extends s.class("MessageboxType"){constructor(e,t="text"){super(e,t),this.active=!0}onActionReset(e){e===this.messagebox&&(this.active=!0,this.$types.children(`[data-id=${this.type}]`).addClass("pso-active"))}}})},{}],11:[function(u,e,g){!function(c){!function(){Object.defineProperty(g,"__esModule",{value:!0}),g.default=void 0;var i=s("undefined"!=typeof window?window.jQuery:void 0!==c?c.jQuery:null),t="undefined"!=typeof window?window._:void 0!==c?c._:null,a="undefined"!=typeof window?window.peepso:void 0!==c?c.peepso:null,e=s("undefined"!=typeof window?window.peepsodata:void 0!==c?c.peepsodata:null),o=u("./util");function s(e){return e&&e.__esModule?e:{default:e}}u("./messagebox-option-abstract"),u("./messagebox-option-moods"),u("./messagebox-option-location"),u("./messagebox-type-abstract"),u("./messagebox-type-text");let n=e.default.ajaxurl_legacy,d=e.default.peepso_nonce,l=e.default.currentuserid,r=e.default.userid,h=window.peepsomessagesdata&&peepsomessagesdata.character_limit;class p{constructor(e){this.id=null,this.$el=(0,i.default)(e),this.$titleExtra=this.$el.find("[data-ps=title-extra]"),this.$textarea=this.$el.find("textarea").attr("maxlength",h),this.$btnCancel=this.$el.find("[data-ps=btn-cancel]").hide(),this.$btnSubmit=this.$el.find("[data-ps=btn-submit]").hide(),this.$textarea.on("focus click",(0,t.throttle)(()=>this.onTextareaFocus(),2e3).bind(this)),this.$textarea.on("input",e=>this.onTextareaInput(e)),this.$textarea.on("paste",e=>setTimeout(()=>this.onTextareaInput(e),100)),this.$btnCancel.on("click",e=>this.onBtnCancelClick(e)),this.$btnSubmit.on("click",e=>this.onBtnSubmitClick(e)),a.hooks.addAction("messages_conversation_open",e=>this.reset(e)),a.hooks.addAction("messages_conversation_enter_to_send",e=>this.initEnterToSend(e)),a.hooks.doAction("messagebox_init",this)}render(){var e=this.data(),e=a.hooks.applyFilters("messagebox_title_extra",[],e,this);e.length?this.$titleExtra.html(e.join(" ")+".").show():this.$titleExtra.empty().hide()}data(){var e={content:this.$textarea.val().trim(),id:l,uid:r,type:"activity",parent_id:this.id};return a.hooks.applyFilters("messagebox_data",e,this)}reset(e=null){this.id=e||this.id,this.$textarea.val("").ps_autosize(),this.$btnCancel.add(this.$btnSubmit).hide(),a.hooks.doAction("messagebox_reset",this)}cancel(){return i.default.Deferred(e=>{this.reset(),e.resolve()})}submit(){return i.default.Deferred(t=>{if(this.submitting)return t.reject();this.submitting=!0,this.$btnSubmit.addClass("pso-btn--loading");let s={url:n+"messagesajax.add_message",type:"POST",data:this.data(),dataType:"json",beforeSend:e=>e.setRequestHeader("X-PeepSo-Nonce",d)};a.hooks.doAction("messages_conversation_before_send",s.data);var e=i.default.ajax(s);e.fail(t.reject),e.done(e=>{e.success?(a.hooks.doAction("messagebox_saved",this),a.hooks.doAction("messages_conversation_sent",s.data),this.reset(),t.resolve()):t.reject()}),e.always(()=>{delete this.submitting,this.$btnSubmit.removeClass("pso-btn--loading")})})}onTextareaFocus(e){a.ajax.post("messagesajax.mark_read_messages_in_conversation?box",{msg_id:this.id})}onTextareaInput(){var e=this.data(),t=e.content.trim(),s=a.hooks.applyFilters("messagebox_is_empty",!t,this,e),t=a.hooks.applyFilters("messagebox_validate",!!t,this,e);s?(this.$btnCancel.hide(),this.$btnSubmit.hide()):(this.$btnCancel.show(),this.$btnSubmit.show().prop("disabled",!t),(0,o.currentlyTyping)(this.id)),s?this.beforeUnloadHandler&&(a.observer.removeFilter("beforeunload",this.beforeUnloadHandler),delete this.beforeUnloadHandler):this.beforeUnloadHandler||(this.beforeUnloadHandler=()=>!0,a.observer.addFilter("beforeunload",this.beforeUnloadHandler))}onBtnCancelClick(e){e.preventDefault(),e.stopPropagation(),this.cancel().done(()=>{})}onBtnSubmitClick(e){e.preventDefault(),e.stopPropagation(),this.submit().done(()=>{})}initEnterToSend(e){let t=this.$el.find("[data-ps=enter-to-send]");t.length&&(t.removeAttr("disabled").prop("checked",!!e),t.off("click").on("click",e=>{a.ajax.post("messagesajax.enter_to_send",{enter_to_send:+e.target.checked})}),this.$textarea.off("keydown").on("keydown",e=>{t.is(":checked")&&"Enter"===e.code&&(e.preventDefault(),e.stopPropagation(),this.submit().done(()=>{}))}))}}g.default=p,peepso.class("Messagebox",()=>p)}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./messagebox-option-abstract":6,"./messagebox-option-location":7,"./messagebox-option-moods":8,"./messagebox-type-abstract":9,"./messagebox-type-text":10,"./util":14}],12:[function(e,t,n){!function(o){!function(){Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var e,s=(e="undefined"!=typeof window?window.jQuery:void 0!==o?o.jQuery:null)&&e.__esModule?e:{default:e},a="undefined"!=typeof window?window.peepso:void 0!==o?o.peepso:null;let t=window.peepsomessagesdata||{},i=!!+t.friends_only&&"is_friend";n.default=class{constructor(e={}){this.$container=(0,s.default)(e.el),this.$postbox=this.$container.find(".ps-postbox-message"),this.$recipientsSingle=this.$container.find(".ps-js-recipient-single").hide(),this.$recipientsMultiple=this.$container.find(".ps-js-recipient-multiple").hide(),this.$recipientsSelect=this.$container.find("select[name=recipients]"),e.args=e.args||{};var t=e.args.id;this.user_id=t,this.flag=i?"is_friend":null,this.args=e.args,delete e.args.id,this.initPostbox(),this.initRecipientsForm()}initPostbox(){this.$postbox=this.$postbox.pspostbox({autosize:!0,text_length:t.character_limit,save_url:"messagesajax.new_message",send_button_text:t.send_button_text,postbox_req:e=>{e={recipients:this.$recipientsSelect.val(),subject:"",message:e.content},e=Object.assign(e,this.args);return console.log(e),e},on_save:e=>{e.data&&e.data.url&&(a.observer.removeFilter("beforeunload",this.$postbox.beforeUnloadHandler),window.location=e.data.url)},on_error:e=>e.errors&&alert(e.errors[0])})}async initRecipientsForm(){var e,t=await this.getAvailableRecipients(this.user_id,this.flag);let i={};t.forEach(e=>i[e.id]=e.avatar),this.user_id?(t=t.find(e=>e.id==this.user_id))&&(e=`<option value="${t.id}">${t.display_name}</option>`,this.$recipientsSelect.html(e).val(t.id),(e=this.$recipientsSingle).find("img").attr("src",t.avatar).attr("alt",t.display_name),e.find(".ps-comment-user").html(t.display_name),e.find("a").attr("href",t.url),e.show()):(this.$recipientsMultiple.show(),this.$recipientsSelect.selectize({valueField:"id",labelField:"display_name",searchField:"display_name",plugins:["remove_button"],closeAfterSelect:!0,render:{option(e,t){var s=t(e.display_name);return`<div><img src="${t(e.avatar||i[e.id]||"")}" /><span>${s}</span></div>`},item(e,t){var s=t(e.display_name);return`<div><img src="${t(e.avatar||i[e.id]||"")}" /><span>${s}</span></div>`}},load:(e,t)=>{this.getAvailableRecipients(this.user_id,this.flag,e).then(t)},onInitialize(){this.$wrapper.append(`<img src="${this.$input.data("loading")}" />`),this.$control_input.on("input",e=>{setTimeout(()=>(0,s.default)(e.currentTarget).trigger("keyup"),0)})}}),this.user_id?(this.$recipientsMultiple.hide(),this.$recipientsSingle.show(),this.$recipientsSelect[0].selectize.onSearchChange("")):(this.$recipientsSingle.hide(),this.$recipientsMultiple.show()))}async getAvailableRecipients(t,s,e){e=await a.ajax.post("messagesajax.get_available_recipients",{user_id:t,keyword:e});let i=[];return i=e.success&&(i=e.data.available_participants||[],t&&(i=i.filter(e=>e.id==t)),s)?i.filter(e=>e[s]):i}}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],13:[function(s,e,d){!function(t){!function(){Object.defineProperty(d,"__esModule",{value:!0}),d.default=void 0;var e,i=(e="undefined"!=typeof window?window.jQuery:void 0!==t?t.jQuery:null)&&e.__esModule?e:{default:e},a="undefined"!=typeof window?window.peepso:void 0!==t?t.peepso:null,o="undefined"!=typeof window?window.peepsodata:void 0!==t?t.peepsodata:null,n=s("./util");d.default=class{constructor(e){this.id=null,this.$el=(0,i.default)(e),this.$loading=this.$el.find("[data-ps=loading]"),this.$items=this.$el.find("[data-ps=items]"),this.$temporary=this.$el.find("[data-ps=temporary]"),this.$typing=this.$el.find("[data-ps=typing]");e=document.querySelector("[data-template=message-item]");this.tmplItem=(0,a.template)(e.innerText),a.hooks.addAction("messages_conversation_open",e=>this.reset(e)),a.hooks.addAction("messages_conversation_before_send",e=>this.actionBeforeSend(e)),a.hooks.addAction("messages_conversation_sent",e=>this.actionSent(e))}reset(e){e!==this.id&&(this.id=e,this.$loading.hide(),this.$items.empty(),this.$temporary.empty(),this.$typing.hide(),this.stopLongPolling(),this.load())}fetch(t={}){let s=i.default.Deferred();var e=i.default.ajax({type:"POST",dataType:"json",beforeSend:e=>e.setRequestHeader("X-PeepSo-Nonce",o.peepso_nonce),url:o.ajaxurl_legacy+"messagesajax.get_messages_in_conversation?new",data:t});return s.abort=e.abort,e.done(e=>{e.success?s.resolve(e.data):e.errors&&1===t.page?s.reject(e.errors):s.resolve({})}).fail(()=>s.reject()),s}load(){var e={msg_id:this.id,get_participants:1,get_options:1,get_unread:1};return this.$items.empty(),this.$loading.show(),this.fetch(e).done(e=>{this.render(e),void 0!==e.enter_to_send&&a.hooks.doAction("messages_conversation_enter_to_send",!!+e.enter_to_send),this.startLongPolling(),setTimeout(()=>this.maybeLoadPrevious(),2e3)}).always(()=>this.$loading.hide())}maybeLoadPrevious(){let e="scroll.ps-message-thread";this.$el.off(e),this.$el.on(e,()=>{this.$el[0].scrollTop<30&&(this.$el.off(e),this.loadPrevious().done(e=>{e.html&&this.maybeLoadPrevious()}))})}loadPrevious(){var e=this.$items.children(".ps-js-message").first(),e={msg_id:this.id,from_id:e.data("id"),direction:"old",get_unread:1};return this.$loading.show(),this.loadPrevXhr&&this.loadPrevXhr.abort(),this.loadPrevXhr=this.fetch(e),this.loadPrevXhr.done(e=>{this.render(e,"prepend"),this.scrollTo("top")}).always(()=>{this.$loading.hide(),delete this.loadPrevXhr})}loadNext(){var e=this.$items.children(".ps-js-message").last(),e={msg_id:this.id,from_id:e.data("id"),direction:"new",get_unread:1};return this.loadNextXhr&&this.loadNextXhr.abort(),this.loadNextXhr=this.fetch(e),this.loadNextXhr.done(e=>{let t=this.$temporary.children(".ps-js-temporary-message");(t=e.ids&&e.ids.length?t.slice(0,e.ids.length):t).remove(),this.render(e),this.scrollTo("bottom"),(this.getTypingHtml(e)||e.ids&&e.ids.length)&&this.restartLongPolling()}).always(()=>delete this.loadNextXhr)}render(e,t="append"){e.html&&(s=(0,n.filterMessages)((0,i.default)(e.html)),this.$items["prepend"===t?"prepend":"append"](s),this.scrollTo("prepend"===t?"top":"bottom"));var s=this.getTypingHtml(e);s?this.$typing.html(s).show():this.$typing.hide().empty(),"append"===t&&(e.html||s)&&requestAnimationFrame(()=>{this.scrollTo("bottom"),(0,n.loadAsyncContents)(e.html||"").then(()=>this.scrollTo("bottom"))}),void 0!==e.receipt&&+e.receipt&&(t=+e.unread||0,this.showUnreadCheckmark(t)),e.html_participants&&a.hooks.doAction("messages_conversation_participants",e.html_participants,e.users),e.html_options&&a.hooks.doAction("messages_conversation_options",e.html_options)}showUnreadCheckmark(e){let t=this.$items.find(".gci-check-circle"),s=(0,i.default)();0<e&&(s=t.slice(0-e),t=t.not(s)),t.addClass("read"),s.removeClass("read")}actionBeforeSend(e){let t;"photo"===e.type?t={type:"photo",count:e.files.length}:"giphy"===e.type&&(t={type:"giphy",count:1}),this.$temporary.append(this.tmplItem({content:e.content,attachment:t})),this.scrollTo("bottom")}actionSent(){this.loadNext()}scrollTo(e){"bottom"===e?this.$el[0].scrollTop=this.$el[0].scrollHeight:"top"===e&&(this.$el[0].scrollTop=0)}startLongPolling(){this.longPollingToken=(new Date).getTime();let s=this.longPollingToken,i=t=>{this.longPollingTimer=setTimeout(()=>{this.loadNext().always(()=>{var e;this.destroyed?console.log(`Requested conversation thread (${this.params.msg_id}) is no longer exist. `+"Terminate corresponding long polling loop!"):s!==this.longPollingToken?console.log("Different token. Terminate corresponding long polling loop!"):(e=Math.min(+o.notification_ajax_delay_multiplier*t,+o.notification_ajax_delay),i(e))})},t)};i(+o.notification_ajax_delay_min)}stopLongPolling(){clearTimeout(this.longPollingTimer),this.longPollingToken=null}restartLongPolling(){this.stopLongPolling(),this.startLongPolling()}getTypingHtml(e){return!e.currently_typing||e.ids&&e.ids.length?"":e.currently_typing}}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./util":14}],14:[function(e,t,n){!function(o){!function(){Object.defineProperty(n,"__esModule",{value:!0}),n.currentlyTyping=void 0,n.filterMessages=function(e){e=(0,s.default)(e).filter(function(){return Node.ELEMENT_NODE===this.nodeType});e=(0,s.default)("<div/>").append(e);return e=t.observer.applyFilters("messages_render",e),t.observer.doAction("peepso_external_link",e),e.children()},n.loadAsyncContents=function(i){return new Promise(e=>{let t=[];var s;"string"==typeof i&&((s=document.createElement("div")).innerHTML=i,s.querySelectorAll(".ps-media__attachment img[src]").forEach(s=>{var e=new Promise(e=>{var t=new Image;t.onload=e,t.src=s.src});t.push(e)})),t.length?Promise.all(t).then(()=>{setTimeout(e,500)}):e()})},n.longPolling=void 0;var s=(e="undefined"!=typeof window?window.jQuery:void 0!==o?o.jQuery:null)&&e.__esModule?e:{default:e},e="undefined"!=typeof window?window._:void 0!==o?o._:null,t="undefined"!=typeof window?window.peepso:void 0!==o?o.peepso:null,i="undefined"!=typeof window?window.peepsodata:void 0!==o?o.peepsodata:null;let a={};n.currentlyTyping=(0,e.debounce)(function(e){var t={url:i.ajaxurl_legacy+"messagesajax.i_am_typing",type:"POST",data:{msg_id:e},dataType:"json",beforeSend:function(e){e.setRequestHeader("X-PeepSo-Nonce",i.peepso_nonce)}};a[e]&&a[e].abort(),a[e]=s.default.ajax(t).always(()=>{delete a[e]})},500);n.longPolling={immediate(){},start(){},stop(){}}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1]);