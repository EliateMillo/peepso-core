!function s(i,n,o){function r(e,t){if(!n[e]){if(!i[e]){var a="function"==typeof require&&require;if(!t&&a)return a(e,!0);if(p)return p(e,!0);throw(t=new Error("Cannot find module '"+e+"'")).code="MODULE_NOT_FOUND",t}a=n[e]={exports:{}},i[e][0].call(a.exports,function(t){return r(i[e][1][t]||t)},a,a.exports,s,i,n,o)}return n[e].exports}for(var p="function"==typeof require&&require,t=0;t<o.length;t++)r(o[t]);return r}({1:[function(t,e,a){t("./tagging"),t("./peepsotags")},{"./peepsotags":2,"./tagging":3}],2:[function(t,e,a){var s=jQuery||$,i=peepso;{var r=s,p=i,d=i.observer;function o(){}o.prototype.init=function(){var s=this;this.taggable_inputs=d.applyFilters("peepsotags_taggable_inputs",["#postbox-main textarea.ps-postbox-textarea"]),this.init_tags(this.taggable_inputs.join(",")),this.init_tags_comments(),r(document).on("peepso_tags_init_comments ps_activitystream_append ps_activitystream_loaded peepso_repost_added",function(){s.init_tags_comments()}),r(document).on("ps_comment_added ps_comment_save",function(){s.init_tags_comments()}),d.addFilter("postbox_req_edit",function(e,t){return t.ps_tagging("val",function(t){e.post=t}),e},10,2),d.addFilter("comment_req",function(e,t){return r(t).ps_tagging("val",function(t){e.content=t,e.post=t}),e},10,2),d.addFilter("comment_cancel",function(t){r(t).ps_tagging("reset")},10,2),d.addFilter("modalcomments.afterchange",function(t){t&&t.$attachment&&t.$attachment.find(".ps-comment-reply textarea").ps_tagging()},10,2),d.addFilter("caption_req",function(e,t){return r(t).ps_tagging("val",function(t){e.description=t}),e},10,2),d.addFilter("comment.reply",(a,s)=>{s.id!=peepsodata.currentuserid&&a.ps_tagging("val",t=>{var e;s.id&&s.name&&(e=_.template(peepsotagsdata.template)({id:s.id,title:s.name}),(t=t.trim())?-1===t.indexOf(e)&&(t+=` ${e} `):t=e+" ",a.val(t),a.removeData("ps_tagging"),this.init_tags_comments(a))})},10,2),d.addAction("postbox_reinit",t=>{t.removeData("ps_tagging"),this.init_tags(t),setTimeout(()=>t.trigger("keyup").trigger("input"),1e3)}),r("#peepso-wrap").on("comment.saved",function(t,e,a,s){r(a).ps_tagging("reset")}),r("#peepso-wrap").on("post_edit.shown",function(t,e,a){a=a.find("textarea");s.init_tags(a)}),d.addAction("comment_edit",r.proxy(function(t,e){e=r(e).find("textarea");this.init_tags(e)},this),10,2),d.addAction("postbox_update",r.proxy(function(t){this.init_tags(t.$text)},this),10,1),d.addFilter("postbox_data",function(e,t){return t.$text.ps_tagging("val",function(t){e.content=t}),e},10,2)},o.prototype.init_tags=function(t){var s,i=!1,n=!1;r(t).one("focus.get_taggable",function(){var t=d.applyFilters("tags_get_taggable_params",{});i=!0,p.postJson("tagsajax.get_taggable",t,function(t){t.success&&(s=t.data.users),"function"==typeof n&&n(s||[]),i=!1})}),r(t).ps_tagging({syntax:_.template(peepsotagsdata.template,{interpolate:/<%=([\s\S]+?)%>/g}),parser:new RegExp(peepsotagsdata.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function(t,e){var a;s?e(s,"cache"):i?n=e:(a=d.applyFilters("tags_get_taggable_params",{}),p.postJson("tagsajax.get_taggable",a,function(t){t.success&&(s=t.data.users),e(s||[])}))}})},o.prototype.init_tags_comments=function(t){r(t=t||'[data-type="stream-newcomment"] textarea[name="comment"]').each(function(t,s){var i,n=!1,o=!1;r(s).off("focus.get_taggable"),r(s).one("focus.get_taggable",function(){var t=d.applyFilters("tags_get_taggable_params",{act_id:r(s).data("act-id")});n=!0,p.postJson("tagsajax.get_taggable",t,function(t){t.success&&(i=t.data.users),"function"==typeof o&&o(i||[]),n=!1})}),r(s).ps_tagging({syntax:_.template(peepsotagsdata.template,{interpolate:/<%=([\s\S]+?)%>/g}),parser:new RegExp(peepsotagsdata.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function(t,e){var a;i?e(i,"cache"):n?o=e:(a=d.applyFilters("tags_get_taggable_params",{act_id:r(s).data("act-id")}),p.postJson("tagsajax.get_taggable",a,function(t){t.success&&(i=t.data.users),e(i||[])}))}}),d.addFilter("comment_can_submit",function(t){return r(t.el).data("ps_tagging").dropdown_is_visible&&(t.can_submit=!1),t},20,1),r(s).ps_autosize()})},o.prototype.apply_line_breaks=function(t){var n=t,e=(n.wrap,n.setAttribute("wrap","off"),n.value),o=(n.value="",n.scrollWidth);function r(t,e,a){var s;if(void 0===e)e=0,a=-1,s=64;else if(-1===a)s=2*e;else{if(a-e<=1)return Math.max(2,a);s=e+(a-e)/2}var i=t.substr(0,s);if(n.value=i,n.scrollWidth>o)a=s;else{if(s>=t.length)return null;e=s}return r(t,e,a)}for(var a=0,s="";a<e.length;){var i=r(e.substr(a));if(null===i){s+=e.substr(a);break}for(var p=i-1,d=p-1;0<=d;d--){var h=e.charAt(a+d);if(" "===h||"-"===h||"+"===h){p=d+1;break}}s+=e.substr(a,p)+"\n",a+=p}n.value=s,n.setAttribute("wrap","")};var h=new o;r(function(){h.init(),r(".ps-postbox-tab.interactions .ps-button-cancel").on("click",function(){r("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")}),r("#postbox-main").on("postbox.post_cancel",function(){r("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")})}),d.addFilter("peepso_postbox_addons",function(t){return t.push({init:r.noop,set_postbox:function(t){var e="postbox-main"===t.attr("id"),a=t.hasClass("ps-postbox-message");(e||a)&&(t.$textarea.hasClass("ps-tagging-textarea")||h.init_tags(t.$textarea),d.addFilter("postbox_req_"+t.guid,function(e){return r("#postbox-main textarea.ps-postbox-textarea").eq(0).ps_tagging("val",function(t){e.content=t}),e},10,1))}}),t},10,1),p.hooks.addAction("postbox_init",a=>{var t=r('<div class="ps-postbox__input-tag"></div>');function s(t,e){t.removeData("ps_tagging"),h.init_tags(t),t.on("input.ps-tagging",()=>n(t,e))}t.insertBefore(a.$textarea),a.$txShadow.addClass("ps-postbox__input-beautifier").appendTo(t),a.$textarea.appendTo(t),p.hooks.addFilter("postbox_data",(e,t)=>(t===a&&e.content&&a.$textarea.ps_tagging("val",t=>e.content=t),e),5),p.hooks.addAction("postbox_reset",t=>{t===a&&a.$textarea.ps_tagging("reset")}),s(a.$textarea,a.$txShadow);let i;p.hooks.addAction("postbox_toggle_type",(t,e)=>{e===a&&("background"===i&&(s(a.$textarea,a.$txShadow),setTimeout(()=>a.$textarea.trigger("keyup").trigger("input"),500)),i=t)})});let n=_.throttle((t,e)=>{var a;(a=window._wpemojiSettings||{})&&a.supports&&(a.supports.everything=!0);let s=p.observer.applyFilters("peepso_postbox_beautifier",t.val()||"",t);s=s.replace(/<(?!\/?ps_)/g,"&lt;").replace(/<(\/?)ps_/g,"<$1").replace(/\r?\n/g,"<br />"),e.html(s)},100)}},{}],3:[function(t,e,a){function s(t,e){return this.textarea=t,this.options=e||{},this.init(),this}var i,n,o,r,p,d,h,g,l,u,c,f,x,v,m,w;i=jQuery,n=_,o=peepso,r=i,p=n,d=/@\[\[([a-z]*\d+):user:([^\]]+)\]\]/g,h=/@\[\[([a-z]*\d+):user:([^\]]+)\]\]/,g=".ps-tagging",l=".ps-postbox__input-tag",u=".ps-postbox__input-beautifier",c=".ps-tagging-hidden",f=".ps-tagging-dropdown",x=".ps-tagging-dropdown-item",v=".active",m=".ps-tagging-loading",s.prototype.init=function(){this.dom_prepare(),this.textarea.value&&(this.parse_tags(),this.textarea_on_input()),this.$textarea.off(g).on("focus"+g,r.proxy(this.textarea_on_keydown,this)).on("click"+g,r.proxy(this.textarea_on_keydown,this)).on("keydown"+g,r.proxy(this.textarea_on_keydown,this)).on("keyup"+g,r.proxy(this.textarea_on_keyup,this)).on("input"+g,r.proxy(this.textarea_on_input,this)).on("blur"+g,r.proxy(this.textarea_on_blur,this)),this.$dropdown.off(g).on("mouseenter"+g,x,r.proxy(this.dropdown_on_mouseenter,this)).on("mousedown"+g,x,r.proxy(this.dropdown_on_mousedown,this)).on("mouseup"+g,x,r.proxy(this.dropdown_on_mouseup,this))},s.prototype.dom_prepare=function(){this.$textarea=r(this.textarea),this.$textarea.addClass(".ps-tagging-textarea".substr(1)),this.$wrapper=this.$textarea.parent(l),this.$wrapper.length||(this.$textarea.wrap('<div class="'+l.substr(1)+'"></div>'),this.$wrapper=this.$textarea.parent()),this.$beautifier=this.$wrapper.children(u),this.$beautifier.length||(this.$beautifier=r('<div class="'+u.substr(1)+'"></div>'),this.$beautifier.prependTo(this.$wrapper)),this.$hidden=this.$wrapper.children(c),this.$hidden.length||(this.$hidden=r('<input type="hidden" class="'+c.substr(1)+'">'),this.$hidden.appendTo(this.$wrapper)),this.$dropdown=this.$wrapper.children(f),this.$dropdown.length||(this.$dropdown=r('<div class="'+f.substr(1)+'"></div>'),this.$dropdown.appendTo(this.$wrapper))},s.prototype.parse_tags=function(){var t,e,a,s,i,n=this.textarea.value;if(this.options.parser&&(t=this.options.parser_groups||{},n=n.replace(this.options.parser,function(){return"@[["+(arguments[t.id]||"")+":user:"+(arguments[t.title]||"")+"]]"})),e=n.match(d),this.textarea.value=n.replace(d,"$2"),this.tags_added=[],e&&e.length)for(i=0;i<e.length;i++)a=e[i].match(h),s=n.indexOf(e[i]),n=n.replace(e[i],a[2]),this.tags_added.push({id:a[1],name:a[2],start:s,length:a[2].length})},s.prototype.reset=function(){this.textarea.value="";var t=this.tags_added=[],e=this;setTimeout(function(){e.$textarea.trigger("keyup"),e.$textarea.trigger("input")}),this.hidden_update("",t),this.dropdown_hide(),this.prev_value=""},s.prototype.val=function(){this.hidden_update_immediate(this.textarea.value||"",this.tags_added||[]);var t=this.$hidden.val();return t="function"==typeof this.options.syntax?t.replace(/@\[\[([a-z]*\d+):user:([^\]]+)\]\]/g,r.proxy(function(t,e,a){return this.options.syntax({id:e,title:a})},this)):t},s.prototype.textarea_on_keydown=function(t){var e=t.keyCode;this.dropdown_is_visible&&0<=[13,27,38,40].indexOf(e)&&(t.preventDefault(),t.stopPropagation()),this.prev_sel_start=this.textarea.selectionStart,this.prev_sel_end=this.textarea.selectionEnd},s.prototype.textarea_on_keyup=function(t){var e=t.keyCode;this.dropdown_is_visible&&(38!==e&&40!==e||(this.dropdown_change_item(e),t.preventDefault(),t.stopPropagation()),13===e&&(this.dropdown_select_item(),t.preventDefault(),t.stopPropagation()),27===e)&&(this.dropdown_hide(),t.preventDefault(),t.stopPropagation())},s.prototype.textarea_on_input=function(t){var e,a,s,i,n,o,r,p,d=this.textarea.value,h=0;if(this.tags_added){if(this.prev_sel_start!==this.prev_sel_end)for(r=0;r<this.tags_added.length;r++)a=(e=this.tags_added[r]).start+e.length,(this.prev_sel_start>e.start&&this.prev_sel_start<a||this.prev_sel_end>e.start&&this.prev_sel_end<a||e.start>=this.prev_sel_start&&a<=this.prev_sel_end)&&this.tags_added.splice(r--,1);for(0<=((t,e)=>{let a=0;if(t===e)return-1;for(;t[a]===e[a];)a++;return a})(d,this.prev_value||"")&&(h=d.length-(this.prev_value||"").length),r=0;r<this.tags_added.length;r++)if((e=this.tags_added[r]).start>=this.prev_sel_start)e.start+=h;else if(!((a=e.start+e.length)<this.prev_sel_start))if(a>this.prev_sel_start){if(0<h)this.tags_added.splice(r--,1);else if(h<0){for(n=(s=d.substring(e.start,this.prev_sel_start+h)).split(" ").length-1,(s=e.name.split(" ")).splice(n,1),s=s.join(" "),i=(i=(i=e.name.split(" ")).slice(0,n)).join(" "),n=new RegExp("^([\\s\\S]{"+e.start+"})([\\s\\S]{"+(e.length+h)+"})"),this.textarea.value=this.textarea.value.replace(n,"$1"+s),this.textarea.setSelectionRange(e.start+i.length,e.start+i.length),d=this.textarea.value,o=e.length-s.length,e.name=s,e.length=s.length,p=r+1;p<this.tags_added.length;p++)this.tags_added[p].start-=o;s.length||this.tags_added.splice(r--,1),r=this.tags_added.length}}else if(h<0){for((s=e.name.split(" ")).pop(),s=s.join(" "),n=new RegExp("^([\\s\\S]{"+e.start+"})([\\s\\S]{"+(e.length+h)+"})"),this.textarea.value=this.textarea.value.replace(n,"$1"+s),this.textarea.setSelectionRange(e.start+s.length,e.start+s.length),d=this.textarea.value,o=e.length-s.length,e.name=s,e.length=s.length,p=r+1;p<this.tags_added.length;p++)this.tags_added[p].start-=o;s.length||this.tags_added.splice(r--,1),r=this.tags_added.length}}this.hidden_update(d,this.tags_added||[]),this.dropdown_toggle(),this.prev_value=d},s.prototype.textarea_on_blur=function(t){},s.prototype.beautifier_update=function(t,e){var a,s,i,n,o;if(e.length){for(a="^",s="",o=i=0;o<e.length;o++)a+="([\\s\\S]{"+((n=e[o]).start-i)+"})([\\s\\S]{"+n.length+"})",s+="$"+(2*o+1)+"[[["+n.name+"]]]",i=n.start+n.length;a=new RegExp(a),t=t.replace(a,s)}return t=t.replace(/\[\[\[([^\[\]]+)\]\]\]/g,'<ps_span class="ps-tag">$1</ps_span>')},s.prototype.hidden_update=p.debounce(function(...t){this.hidden_update_immediate(...t)},50),s.prototype.hidden_update_immediate=function(t,e){var a,s,i,n,o;if(e.length){for(a="^",s="",o=i=0;o<e.length;o++)a+="([\\s\\S]{"+((n=e[o]).start-i)+"})([\\s\\S]{"+n.length+"})",s+="$"+(2*o+1)+"@[["+n.id+":user:"+n.name+"]]",i=n.start+n.length;a=new RegExp(a),t=t.replace(a,s)}this.$hidden.val(t)},s.prototype.dropdown_toggle=p.debounce(function(){var t=this.textarea.selectionStart,e=this.textarea.value.substr(0,t),a=e.lastIndexOf("@");a<0||0<a&&!e[a-1].match(/\s/)||0<=a&&e.substr(a).match(/\s/)||++a>=t?this.dropdown_hide():(e=e.substring(a,t),this.dropdown_fetch(e,r.proxy(this.dropdown_update,this)))},200),s.prototype.dropdown_fetch=function(a,s){"function"!=typeof this.options.fetcher?s(a,[]):this.dropdown_fetching||(this.dropdown_fetching=!0,this.$dropdown.find(m).show(),this.options.fetcher(a,r.proxy(function(t,e){this.$dropdown.find(m).hide(),this.dropdown_fetching=!1,"cache"===e?s(a,t):this.dropdown_toggle()},this)))},s.prototype.dropdown_filter=function(e,t){var a=[];return this.tags_added&&this.tags_added.length&&(a=p.map(this.tags_added,function(t){return""+t.id})),e=e.toLowerCase(),p.filter(t,function(t){return-1===a.indexOf(""+t.id)&&-1<t.name.toLowerCase().indexOf(e)})},s.prototype.dropdown_update=function(t,e){(e=this.dropdown_filter(t,e)).length?(t=e.map(t=>`<div class="${x.substr(1)}" data-id="${t.id}" data-name="${t.name}">
				<a href="#" onclick="return false;">
					<div class="ps-avatar"><img src="${t.avatar}"></div>
					<span>${t.name}</span>
				</a>
			</div>`),this.dropdown_show(t)):this.dropdown_hide()},s.prototype.dropdown_show=function(t){this.$dropdown.html(t).show(),this.dropdown_is_visible=!0},s.prototype.dropdown_show_more=function(){},s.prototype.dropdown_hide=function(){this.$dropdown.hide(),this.dropdown_is_visible=!1},s.prototype.dropdown_on_mouseenter=function(t){this.dropdown_change_item(t)},s.prototype.dropdown_on_mousedown=function(){this.dropdown_is_clicked=!0},s.prototype.dropdown_on_mouseup=function(t){this.dropdown_select_item(t),this.dropdown_is_clicked=!1,this.dropdown_hide()},s.prototype.dropdown_change_item=function(t){var e,a,s=v.substr(1);"number"!=typeof t?(a=(e=this.dropdown_selected_item=r(t.target)).siblings(v),e.addClass(s),a.removeClass(s)):(e=this.$dropdown.children(v)).length?(a=e[38===t?"prev":"next"](),e.removeClass(s),a.length?(this.dropdown_selected_item=a).addClass(s):this.dropdown_selected_item=!1):(e=this.dropdown_selected_item=this.$dropdown.children()[38===t?"last":"first"]()).addClass(s)},s.prototype.dropdown_select_item=function(t){var t=t?r(t.currentTarget):this.dropdown_selected_item,e=t.data("id"),t=t.data("name"),a=this.textarea.selectionStart,s=this.textarea.value.substr(0,a).lastIndexOf("@"),i=(this.tags_added||(this.tags_added=[]),this.tags_added.push({id:e,name:t,start:s,length:t.length}),e=new RegExp("^([\\s\\S]{"+s+"})[\\s\\S]{"+(a-s)+"}"),a=this.textarea.value.replace(e,"$1"+t)+" ",this.textarea.value=a,this.textarea.setSelectionRange(s+t.length+1,s+t.length+1),this);setTimeout(function(){i.$textarea.trigger("keyup"),i.$textarea.trigger("input")}),this.hidden_update(a,this.tags_added),this.dropdown_hide(),this.$textarea.focus()},w=s,i.fn.ps_tagging=function(a,s){return"object"==typeof a&&(s=a),this.each(function(){var t=i(this),e=t.data("ps_tagging");e||(e=new w(this,s),t.data("ps_tagging",e)),"val"===a&&"function"==typeof s?s(e.val()):"reset"===a&&e.reset()})},o.observer.addFilter("peepso_postbox_beautifier",function(t,e){var a=e.data("ps_tagging"),e=e.val(),s=a.tags_added||[];return a.beautifier_update(e,s)},10,2)},{}]},{},[1]);